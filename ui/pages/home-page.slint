import { VerticalBox, HorizontalBox, ComboBox } from "std-widgets.slint";
import { Theme, Layout } from "../theme.slint";
import { CrudListItem, QuickAction } from "../models.slint";
import { CrudList } from "../components/crud-list.slint";

// ============================================================================
// Home Page Component - Fonds Management with MVVM Architecture
// ============================================================================
export component HomePage inherits Rectangle {
    background: Theme.bg_primary;

    // Toolbar data
    in property <[string]> archive_libraries: [];
    in-out property <int> selected_archive: 0;
    in property <[string]> fonds_names: [];
    in-out property <int> selected_fonds: 0;
    in-out property <string> last_opened_library: "";
    in property <[string]> library_names: [];

    // Initialization callback
    callback initialize();

    // Series list data (simplified for now)
    in-out property <int> selected_series_index: -1;
    in-out property <string> selected_series_no: "";
    in property <[CrudListItem]> series_list_items: [];

    // Files data (simplified for now)
    in-out property <int> selected_file: 0;
    in property <[CrudListItem]> files_list_items: [];

    // Items data (simplified for now)
    in-out property <int> selected_item: 0;
    in property <[CrudListItem]> items_list_items: [];

    in-out property <string> open_file_path: "";
    in-out property <string> open_item_path: "";

    // Toolbar callbacks
    callback request_add_fonds_dialog();
    callback archive_selected(int);
    callback open_fonds(string);

    // Series callbacks
    callback select_series(int, string);
    callback series_activated(int);
    callback rebuild_series();
    callback delete_series();

    // File callbacks
    callback add_file();
    callback delete_file();
    callback rename_file(int, string);
    callback file_clicked(int);
    callback file_activated(int);
    callback open_file();
    callback open_file_at(int);  // Open file at specific index

    // Item callbacks
    callback add_item();
    callback delete_item();
    callback rename_item(int, string);
    callback item_clicked(int);
    callback item_activated(int);
    callback open_item();
    callback open_item_at(int);  // Open item at specific index

    callback file_selected(int);

    VerticalBox {
        width: parent.width;
        height: parent.height;
        spacing: 0px;

        // Initialize the page
        init => {
            root.initialize();
        }

        // Top Toolbar
        Rectangle {
            height: 48px;
            background: Theme.toolbar_background;

            HorizontalBox {
                padding: 8px;
                spacing: 8px;

                ComboBox {
                    width: 180px;
                    model: root.library_names;
                    current-index <=> root.selected_archive;
                    selected(value) => {
                        root.archive_selected(root.selected_archive);
                    }
                }

                ComboBox {
                    width: 400px;
                    model: root.fonds_names;
                    current-index <=> root.selected_fonds;
                    selected(value) => {
                        if root.selected_fonds >= 0 && root.selected_fonds < root.fonds_names.length {
                            root.open_fonds(root.fonds_names[root.selected_fonds]);
                        }
                    }
                }

                Rectangle {
                    width: 32px;
                    height: 32px;
                    border-radius: 4px;
                    background: add_fonds_touch.has-hover ? Theme.brand_soft : transparent;

                    Text {
                        width: 100%;
                        height: 100%;
                        text: "âž•";
                        font-size: 18px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    add_fonds_touch := TouchArea {
                        clicked => { root.request_add_fonds_dialog(); }
                    }
                }
            }
        }

        // Main content area
        HorizontalBox {
            horizontal-stretch: 1;
            spacing: 0px;

            // Left side - Series list
            CrudList {
                width: 320px;
                title: @tr("label_series");
                items: root.series_list_items;
                active-index <=> root.selected_series_index;
                show-add-button: false;
                toolbar-actions: [
                    { icon: "ðŸ”„", tooltip: "Rebuild" }
                ];

                item-clicked(index) => {
                    // Series doesn't support multi-selection, just activate
                    root.selected_series_index = index;
                    // TODO: Access series data when available
                    root.select_series(index, "");
                }

                item-activated(index) => {
                    // TODO: Access series data when available
                    root.series_activated(index);
                }

                toolbar-action-clicked(action_idx) => {
                    if action_idx == 0 {
                        root.rebuild_series();
                    }
                }

                delete-clicked => { root.delete_series(); }
            }

            // Separator
            Rectangle { width: Layout.separator_width; background: Theme.nav_border; }

            // Right side - Files and Items
            VerticalBox {
                horizontal-stretch: 1;
                height: 100%;

                // Files section
                CrudList {
                    vertical-stretch: 1;
                    title: @tr("label_files");
                    items: root.files_list_items;
                    active-index <=> root.selected_file;
                    show-rename-menu: true;
                    quick-actions: [
                        { icon: "ðŸ”—", tooltip: "Open" }
                    ];

                    add-clicked => { root.add_file(); }

                    item-clicked(index) => {
                        root.file_clicked(index);
                    }

                    item-activated(index) => {
                        root.file_activated(index);
                    }

                    quick-action-clicked(item_idx, action_idx) => {
                        // action_idx 0 = open file
                        if action_idx == 0 {
                            root.open_file_at(item_idx);
                        }
                    }

                    rename-clicked(index, old_name) => { root.rename_file(index, old_name); }
                    delete-clicked => { root.delete_file(); }
                }

                // Separator
                Rectangle { height: Layout.separator_width; background: Theme.nav_border; }

                // Items section
                CrudList {
                    vertical-stretch: 1;
                    title: @tr("label_items");
                    items: root.items_list_items;
                    active-index <=> root.selected_item;
                    activate-first-on-load: false;
                    show-rename-menu: true;
                    quick-actions: [
                        { icon: "ðŸ”—", tooltip: "Open" }
                    ];

                    add-clicked => { root.add_item(); }

                    item-clicked(index) => {
                        root.item_clicked(index);
                    }

                    item-activated(index) => {
                        root.item_activated(index);
                    }

                    quick-action-clicked(item_idx, action_idx) => {
                        // action_idx 0 = open item
                        if action_idx == 0 {
                            root.open_item_at(item_idx);
                        }
                    }

                    rename-clicked(index, old_name) => { root.rename_item(index, old_name); }
                    delete-clicked => { root.delete_item(); }
                }
            }
        }
    }
}