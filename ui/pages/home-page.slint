import { VerticalBox, HorizontalBox, ComboBox } from "std-widgets.slint";
import { Theme, Layout } from "../theme.slint";
import { CrudListItem, QuickAction, SeriesItem, FileItem, ItemItem, DialogField, DialogFieldType } from "../models.slint";
import { CrudList } from "../components/crud-list.slint";
import { FormDialog } from "../components/dialogs.slint";

// ============================================================================
// Home Page Component - Fonds Management with MVVM Architecture
// ============================================================================
export component HomePage inherits Rectangle {
    background: Theme.bg_primary;

    // Toolbar data
    in property <[string]> archive_libraries: [];
    in-out property <int> selected_archive: -1;
    in property <[string]> fonds_names: [];
    in-out property <int> selected_fonds: 0;
    in-out property <string> last_opened_library: "";
    in property <[string]> library_names: [];

    // Initialization callback
    callback initialize();

    // Series list data
    in-out property <int> selected_series_index: -1;
    in-out property <string> selected_series_no: "";
    in property <[CrudListItem]> series_list_items: [];

    // Files data
    in-out property <int> selected_file: 0;
    in property <[CrudListItem]> files_list_items: [];

    // Items data
    in-out property <int> selected_item: 0;
    in property <[CrudListItem]> items_list_items: [];

    in-out property <string> open_file_path: "";
    in-out property <string> open_item_path: "";

    // Dialog states
    in-out property <bool> show_add_file_dialog: false;
    in-out property <[DialogField]> add_file_fields: [];
    in-out property <bool> show_add_item_dialog: false;
    in-out property <[DialogField]> add_item_fields: [];

    // Current language for dialogs
    in property <int> current_language: 0;

    // Toolbar callbacks
    callback request_add_fonds_dialog();
    callback archive_selected(int);
    callback fonds_selected(int);

    // Series callbacks
    callback select_series(int, string);
    callback series_selected(int);
    callback series_activated(int);
    callback rebuild_series();
    callback delete_series();

    // File callbacks
    callback add_file();
    callback delete_file();
    callback rename_file(int, string);
    callback file_clicked(int);
    callback file_activated(int);
    callback open_file();
    callback open_file_at(int);  // Open file at specific index

    // Item callbacks
    callback add_item();
    callback add_folder_item();
    callback delete_item();
    callback rename_item(int, string);
    callback item_clicked(int);
    callback item_activated(int);
    callback open_item();
    callback open_item_at(int);  // Open item at specific index

    callback file_selected(int);

    // Dialog callbacks
    callback confirm_add_file([DialogField]);
    callback cancel_add_file();
    callback browse_file_folder(int);
    callback confirm_add_item([DialogField]);
    callback cancel_add_item();
    callback browse_item_folder(int);

    VerticalBox {
        width: parent.width;
        height: parent.height;
        spacing: 0px;

        // Initialize the page
        init => {
            root.initialize();
        }

        // Top Toolbar
        Rectangle {
            height: 48px;
            background: Theme.toolbar_background;

            HorizontalBox {
                padding: 8px;
                spacing: 8px;

                ComboBox {
                    width: 180px;
                    model: root.library_names;
                    current-index <=> root.selected_archive;
                    selected(value) => {
                        root.archive_selected(root.selected_archive);
                    }
                }

                ComboBox {
                    width: 400px;
                    model: root.fonds_names;
                    current-index <=> root.selected_fonds;
                    selected(value) => {
                        // Use index-based callback (historical implementation)
                        root.fonds_selected(root.selected_fonds);
                    }
                }

                Rectangle {
                    width: 32px;
                    height: 32px;
                    border-radius: 4px;
                    background: add_fonds_touch.has-hover ? Theme.brand_soft : transparent;

                    Text {
                        width: 100%;
                        height: 100%;
                        text: "âž•";
                        font-size: 18px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    add_fonds_touch := TouchArea {
                        clicked => { root.request_add_fonds_dialog(); }
                    }
                }
            }
        }

        // Main content area
        HorizontalBox {
            horizontal-stretch: 1;
            spacing: 0px;

            // Left side - Series list
            CrudList {
                width: 320px;
                title: @tr("label_series");
                items: root.series_list_items;
                active-index <=> root.selected_series_index;
                show-add-button: false;
                toolbar-actions: [
                    { icon: "ðŸ”„", tooltip: "Rebuild" }
                ];

                item-clicked(index) => {
                    // Series doesn't support multi-selection, just activate
                    root.selected_series_index = index;
                    // Trigger series selection to load corresponding files
                    root.series_selected(index);
                }

                item-activated(index) => {
                    // TODO: Access series data when available
                    root.series_activated(index);
                }

                toolbar-action-clicked(action_idx) => {
                    if action_idx == 0 {
                        root.rebuild_series();
                    }
                }

                delete-clicked => { root.delete_series(); }
            }

            // Separator
            Rectangle { width: Layout.separator_width; background: Theme.nav_border; }

            // Right side - Files and Items
            VerticalBox {
                horizontal-stretch: 1;
                height: 100%;

                // Files section
                CrudList {
                    vertical-stretch: 1;
                    title: @tr("label_files");
                    items: root.files_list_items;
                    active-index <=> root.selected_file;
                    show-rename-menu: true;
                    quick-actions: [
                        { icon: "ðŸ”—", tooltip: "Open" }
                    ];

                    add-clicked => {
                        root.add_file_fields = [
                            { label: @tr("label_name"), field_type: DialogFieldType.text, value: "", placeholder: @tr("placeholder_file_name") },
                            { label: @tr("label_path"), field_type: DialogFieldType.path, value: "", placeholder: @tr("placeholder_file_path") },
                        ];
                        root.show_add_file_dialog = true;
                    }

                    item-clicked(index) => {
                        root.file_clicked(index);
                    }

                    item-activated(index) => {
                        root.file_activated(index);
                    }

                    quick-action-clicked(item_idx, action_idx) => {
                        // action_idx 0 = open file
                        if action_idx == 0 {
                            root.open_file_at(item_idx);
                        }
                    }

                    rename-clicked(index, old_name) => { root.rename_file(index, old_name); }
                    delete-clicked => { root.delete_file(); }
                }

                // Separator
                Rectangle { height: Layout.separator_width; background: Theme.nav_border; }

                // Items section
                CrudList {
                    vertical-stretch: 1;
                    title: @tr("label_items");
                    items: root.items_list_items;
                    active-index <=> root.selected_item;
                    activate-first-on-load: false;
                    show-rename-menu: true;
                    toolbar-actions: [
                        { icon: "ðŸ“", tooltip: "Add Folder" }
                    ];
                    quick-actions: [
                        { icon: "ðŸ”—", tooltip: "Open" }
                    ];

                    add-clicked => {
                        root.add_item_fields = [
                            { label: @tr("label_name"), field_type: DialogFieldType.text, value: "", placeholder: @tr("placeholder_item_name") },
                            { label: @tr("label_path"), field_type: DialogFieldType.path, value: "", placeholder: @tr("placeholder_item_path") },
                        ];
                        root.show_add_item_dialog = true;
                    }

                    item-clicked(index) => {
                        root.item_clicked(index);
                    }

                    item-activated(index) => {
                        root.item_activated(index);
                    }

                    quick-action-clicked(item_idx, action_idx) => {
                        // action_idx 0 = open item
                        if action_idx == 0 {
                            root.open_item_at(item_idx);
                        }
                    }

                    toolbar-action-clicked(action_idx) => {
                        if action_idx == 0 {
                            // Add folder action
                            root.add_folder_item();
                        }
                    }

                    rename-clicked(index, old_name) => { root.rename_item(index, old_name); }
                    delete-clicked => { root.delete_item(); }
                }
            }
        }
    }

    // Add File Dialog
    if root.show_add_file_dialog : FormDialog {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        title: @tr("dialog_add_file_title");
        current_language: root.current_language;
        fields <=> root.add_file_fields;
        
        confirm(fields) => {
            root.confirm_add_file(fields);
            root.show_add_file_dialog = false;
        }
        
        cancel() => {
            root.cancel_add_file();
            root.show_add_file_dialog = false;
        }
        
        browse_folder(index) => {
            root.browse_file_folder(index);
        }
    }

    // Add Item Dialog
    if root.show_add_item_dialog : FormDialog {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        title: @tr("dialog_add_item_title");
        current_language: root.current_language;
        fields <=> root.add_item_fields;
        
        confirm(fields) => {
            root.confirm_add_item(fields);
            root.show_add_item_dialog = false;
        }
        
        cancel() => {
            root.cancel_add_item();
            root.show_add_item_dialog = false;
        }
        
        browse_folder(index) => {
            root.browse_item_folder(index);
        }
    }
}