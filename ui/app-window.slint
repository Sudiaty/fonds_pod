import { Button, VerticalBox, HorizontalBox, GroupBox, ComboBox, ScrollView } from "std-widgets.slint";
import { Theme, Layout } from "theme.slint";
import { Translations } from "translations.slint";
import { SidebarButtonWithTooltip } from "components.slint";
import { SchemaInputDialog, RenameArchiveDialog, SchemaItemInputDialog, ClassificationInputDialog, ClassificationChildInputDialog, ThemedButton, ConfirmDialog } from "dialogs.slint";

// Archive Library struct for settings display
export struct ArchiveLibraryItem {
    name: string,
    path: string,
}

// Schema struct for schema management display
export struct SchemaItem {
    code: string,
    name: string,
}

// Schema Item struct for schema items display
export struct SchemaItemDetail {
    code: string,
    name: string,
}

export struct ClassificationItem {
    code: string,
    name: string,
    is_active: bool,
}

export { SchemaInputDialog, RenameArchiveDialog, SchemaItemInputDialog, ClassificationInputDialog, ClassificationChildInputDialog }

export component AppWindow inherits Window {
    title: "FondsPod";
    width: 1000px;
    height: 700px;
    background: Theme.bg_primary;
    default-font-family: "Microsoft YaHei";
    default-font-size: 14px;
    
    property <string> current_page: "fonds";
    property <[string]> fonds_list: ["2020-HR", "2020-IT", "2021-HR", "2021-IT"];
    property <int> selected_fonds: 0;
    property <[string]> schema_list: ["Year", "Department", "Category"];
    in-out property <[SchemaItem]> schema_items: [];
    property <[string]> item_list: ["2020", "2021", "2022"];
    in-out property <[SchemaItemDetail]> item_details: [];
    in-out property <int> selected_schema: 0;
    in-out property <[int]> selected_schemas: [];
    in-out property <int> selected_item: 0;
    in-out property <[int]> selected_items: [];
    property <[string]> series: ["2020-HR", "2020-IT", "2021-HR", "2021-IT"];
    property <[string]> files: ["002", "003"];
    property <int> selected_series: 0;
    property <int> selected_file: 0;
    in-out property <[string]> archive_libraries: ["Default Archive"];
    in-out property <[ArchiveLibraryItem]> archive_library_items: [];
    in-out property <int> selected_archive: 0;
    // Classification management properties
    in-out property <[ClassificationItem]> classification_items: []; // reuse struct: code/name
    in-out property <[ClassificationItem]> classification_children: [];
    in-out property <int> selected_classification: 0;
    in-out property <[int]> selected_classifications: [];
    in-out property <int> selected_child: 0;
    in-out property <[int]> selected_children: [];
    
    // Toast notification properties
    in-out property <string> toast_message: "";
    in-out property <bool> toast_visible: false;
    
    // Callbacks
    callback show_toast(string);
    callback add_fonds();
    callback delete_fonds();
    callback open_fonds(string);
    callback add_schema();
    callback delete_schema();
    callback delete_selected_schemas();
    callback schema_item_clicked(int, bool, bool);
    callback add_schema_item();
    callback delete_schema_item();
    callback delete_selected_items();
    callback schema_item_item_clicked(int, bool, bool);
    callback schema_selected(int);
    callback load_schemas([string]);
    callback load_schema_items([string]);
    callback get_current_schema_index() -> int;
    callback get_current_item_index() -> int;
    callback get_current_schema_name() -> string;
    callback get_current_item_name() -> string;
    // Classification callbacks
    callback add_classification();
    callback delete_classification();
    callback delete_selected_classifications();
    callback classification_item_clicked(int, bool, bool);
    callback classification_selected(int);
    callback add_child_classification();
    callback delete_child_classification();
    callback delete_selected_children();
    callback child_classification_clicked(int, bool, bool);
    callback load_classifications([string]);
    callback load_classification_children([string]);
    callback get_current_classification_index() -> int;
    callback get_current_child_index() -> int;
    callback get_current_classification_name() -> string;
    callback get_current_child_name() -> string;
    callback activate_classification();
    callback deactivate_classification();
    callback activate_child_classification();
    callback deactivate_child_classification();
    callback export_classifications();
    callback import_classifications();
    
    load_schemas(schemas) => {
        root.schema_list = schemas;
        root.selected_schema = 0;
    }
    load_schema_items(items) => {
        root.item_list = items;
        root.selected_item = 0;
    }
    get_current_schema_index => {
        return root.selected_schema;
    }
    get_current_item_index => {
        return root.selected_item;
    }
    get_current_schema_name => {
        if root.selected_schema >= 0 && root.selected_schema < root.schema_list.length {
            return root.schema_list[root.selected_schema];
        }
        return "";
    }
    get_current_item_name => {
        if root.selected_item >= 0 && root.selected_item < root.item_list.length {
            return root.item_list[root.selected_item];
        }
        return "";
    }
    // Classification helper invocations
    load_classifications(classifications) => {
        // Backward compatibility string list not used yet
        // Set structured model externally via set_classification_items
        root.selected_classification = 0;
    }
    load_classification_children(children) => {
        root.selected_child = 0;
    }
    get_current_classification_index => { return root.selected_classification; }
    get_current_child_index => { return root.selected_child; }
    get_current_classification_name => {
        if root.selected_classification >= 0 && root.selected_classification < root.classification_items.length {
            return root.classification_items[root.selected_classification].name;
        }
        return "";
    }
    get_current_child_name => {
        if root.selected_child >= 0 && root.selected_child < root.classification_children.length {
            return root.classification_children[root.selected_child].name;
        }
        return "";
    }
    callback add_file();
    callback delete_file();
    callback open_file();
    callback update_series();
    callback add_archive_library();
    callback remove_archive_library();
    callback rename_archive_library(int, string);
    callback apply_settings();
    callback cancel_settings();
    
    // Helper functions for accessing global Translations
    public function set_language(index: int) {
        Translations.language = index;
    }
    
    public function get_language() -> int {
        return Translations.language;
    }
    
    // Helper functions for multi-selection
    pure public function schema_is_selected(idx: int) -> bool {
        if root.selected_schemas.length == 0 {
            return false;
        }
        // Check if idx is in selected_schemas array
        return root.selected_schemas[idx] == 1;
    }
    
    pure public function item_is_selected(idx: int) -> bool {
        if root.selected_items.length == 0 {
            return false;
        }
        // Check if idx is in selected_items array
        return root.selected_items[idx] == 1;
    }
    pure public function classification_is_selected(idx: int) -> bool {
        if root.selected_classifications.length == 0 { return false; }
        return root.selected_classifications[idx] == 1;
    }
    pure public function child_is_selected(idx: int) -> bool {
        if root.selected_children.length == 0 { return false; }
        return root.selected_children[idx] == 1;
    }
    
    HorizontalBox {
        spacing: 0px;
        
        // Left Navigation - Icon-only sidebar (VS Code style)
        VerticalBox {
            width: 50px;
            padding: 0px;
            spacing: 0px;
            alignment: start;
            
            btn_fonds := SidebarButtonWithTooltip {
                icon: "ðŸ“";
                tooltip: Translations.nav_fonds;
                is_active: root.current_page == "fonds";
                clicked => { root.current_page = "fonds"; }
            }
            
            btn_schema := SidebarButtonWithTooltip {
                icon: "âš™ï¸";
                tooltip: Translations.nav_schema;
                is_active: root.current_page == "schema";
                clicked => { root.current_page = "schema"; }
            }

            btn_classification := SidebarButtonWithTooltip {
                icon: "ðŸ—‚";
                tooltip: Translations.nav_classification;
                is_active: root.current_page == "classification";
                clicked => { root.current_page = "classification"; }
            }
            
            btn_settings := SidebarButtonWithTooltip {
                icon: "ðŸ”§";
                tooltip: Translations.nav_settings;
                is_active: root.current_page == "settings";
                clicked => { root.current_page = "settings"; }
            }
            
            btn_files := SidebarButtonWithTooltip {
                icon: "ðŸ“‚";
                tooltip: Translations.nav_files;
                is_active: root.current_page == "files";
                clicked => { root.current_page = "files"; }
            }
        }
        
        // Separator
        Rectangle {
            width: Layout.separator_width;
            background: Theme.nav_border;
        }
        
        // Main Content Area
        VerticalBox {
            // Fonds Management
            if root.current_page == "fonds" : VerticalBox {
                Rectangle {
                    height: Layout.toolbar_height;
                    background: Theme.toolbar_background;
                    
                    HorizontalBox {
                        padding: Layout.standard_padding;
                        spacing: Layout.standard_spacing;
                        
                        ComboBox {
                            model: root.archive_libraries;
                            current-index: root.selected_archive;
                        }
                        ThemedButton { text: Translations.btn_add_fonds; is_primary: true; clicked => { root.add_fonds(); } }
                        ThemedButton { text: Translations.btn_delete; is_primary: false; clicked => { root.delete_fonds(); } }
                    }
                }
                
                VerticalBox {
                    for item[index] in root.fonds_list : Rectangle {
                        height: Layout.list_item_height;
                        background: root.selected_fonds == index ? Theme.list_selected : Theme.list_background;
                        
                        HorizontalBox {
                            padding: Layout.standard_spacing;
                            Text { text: item; }
                        }
                        
                        TouchArea {
                            clicked => {
                                root.selected_fonds = index;
                            }
                            double-clicked => {
                                root.open_fonds(item);
                            }
                        }
                    }
                }
            }
            
            // Schema Management
            if root.current_page == "schema" : HorizontalBox {
                spacing: 0px;
                
                // Left side - Schema list (40% width)
                VerticalBox {
                    horizontal-stretch: 0.4;
                    padding: Layout.standard_padding;
                    spacing: Layout.standard_spacing;
                    
                    // Toolbar with icon button
                    HorizontalBox {
                        height: 40px;
                        padding: 5px;
                        spacing: Layout.standard_spacing;
                        alignment: start;
                        
                        Text { text: Translations.label_schema; font-size: 14px; vertical-alignment: center; }
                        
                        Rectangle {
                            width: 32px;
                            height: 32px;
                            border-radius: 4px;
                            background: add_schema_touch.has-hover ? Theme.brand_soft : transparent;
                            
                            Text {
                                x: 0;
                                y: 2px;
                                width: 32px;
                                height: 32px;
                                text: "âž•";
                                font-size: 18px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                            
                            add_schema_touch := TouchArea {
                                clicked => { root.add_schema(); }
                            }
                        }
                    }
                    
                    ScrollView {
                        VerticalBox {
                            for schema_item[index] in root.schema_items : Rectangle {
                                height: 50px;
                                background: root.selected_schemas.length > 0 ? (root.schema_is_selected(index) ? Theme.list_selected : Theme.list_background) : (root.selected_schema == index ? Theme.list_selected : Theme.list_background);
                                border-width: 1px;
                                border-color: Theme.nav_border;
                                
                                VerticalBox {
                                    padding-left: 10px;
                                    padding-right: 10px;
                                    padding-top: 6px;
                                    padding-bottom: 6px;
                                    spacing: 2px;
                                    
                                    Text {
                                        text: schema_item.code;
                                        font-size: 14px;
                                        font-weight: 600;
                                        color: #333;
                                        overflow: elide;
                                    }
                                    
                                    Text {
                                        text: schema_item.name;
                                        font-size: 12px;
                                        color: #666;
                                        overflow: elide;
                                    }
                                }
                                
                                schema_area := TouchArea {
                                    pointer-event(event) => {
                                        if event.kind == PointerEventKind.down && event.button == PointerEventButton.left {
                                            root.schema_item_clicked(index, event.modifiers.control, event.modifiers.shift);
                                        }
                                        if event.kind == PointerEventKind.up && event.button == PointerEventButton.right {
                                            if root.selected_schemas.length == 0 || !root.schema_is_selected(index) {
                                                root.selected_schema = index;
                                                root.selected_schemas = [];
                                            }
                                            schema_menu.show();
                                        }
                                    }
                                }
                                
                                schema_menu := PopupWindow {
                                    x: schema_area.mouse-x;
                                    y: schema_area.mouse-y;
                                    width: 120px;
                                    
                                    Rectangle {
                                        background: white;
                                        border-width: 1px;
                                        border-color: #ccc;
                                        border-radius: 4px;
                                        drop-shadow-blur: 10px;
                                        drop-shadow-color: #00000040;
                                        
                                        VerticalBox {
                                            spacing: 0px;
                                            
                                            Rectangle {
                                                height: 32px;
                                                background: del_schema_area.has-hover ? Theme.bg_soft : transparent;
                                                
                                                HorizontalBox {
                                                    padding-left: 12px;
                                                    padding-right: 12px;
                                                    
                                                    Text {
                                                        text: Translations.menu_delete;
                                                        font-size: 13px;
                                                        color: Theme.brand_primary;
                                                        vertical-alignment: center;
                                                    }
                                                }
                                                
                                                del_schema_area := TouchArea {
                                                    clicked => {
                                                        schema_menu.close();
                                                        if root.selected_schemas.length > 0 {
                                                            root.delete_selected_schemas();
                                                        } else {
                                                            root.delete_schema();
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                // Divider
                Rectangle {
                    width: Layout.separator_width;
                    background: Theme.nav_border;
                }
                
                // Right side - Items list (60% width)
                VerticalBox {
                    horizontal-stretch: 0.6;
                    padding: Layout.standard_padding;
                    spacing: Layout.standard_spacing;
                    
                    // Toolbar with icon button
                    HorizontalBox {
                        height: 40px;
                        padding: 5px;
                        spacing: Layout.standard_spacing;
                        alignment: start;
                        
                        Text { text: Translations.label_items; font-size: 14px; vertical-alignment: center; }
                        
                        Rectangle {
                            width: 32px;
                            height: 32px;
                            border-radius: 4px;
                            background: add_item_btn.has-hover ? Theme.brand_soft : transparent;
                            
                            Text {
                                x: 0;
                                y: 2px;
                                width: 32px;
                                height: 32px;
                                text: "âž•";
                                font-size: 18px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                            
                            add_item_btn := TouchArea {
                                clicked => { root.add_schema_item(); }
                            }
                        }
                    }
                    
                    ScrollView {
                        VerticalBox {
                            for detail_item[index] in root.item_details : Rectangle {
                                height: 50px;
                                background: root.selected_items.length > 0 ? (root.item_is_selected(index) ? Theme.list_selected : Theme.list_background) : (root.selected_item == index ? Theme.list_selected : Theme.list_background);
                                border-width: 1px;
                                border-color: Theme.nav_border;
                                
                                VerticalBox {
                                    padding-left: 10px;
                                    padding-right: 10px;
                                    padding-top: 6px;
                                    padding-bottom: 6px;
                                    spacing: 2px;
                                    
                                    Text {
                                        text: detail_item.code;
                                        font-size: 14px;
                                        font-weight: 600;
                                        color: #333;
                                        overflow: elide;
                                    }
                                    
                                    Text {
                                        text: detail_item.name;
                                        font-size: 12px;
                                        color: #666;
                                        overflow: elide;
                                    }
                                }
                                
                                item_area := TouchArea {
                                    pointer-event(event) => {
                                        if event.kind == PointerEventKind.down && event.button == PointerEventButton.left {
                                            root.schema_item_item_clicked(index, event.modifiers.control, event.modifiers.shift);
                                        }
                                        if event.kind == PointerEventKind.up && event.button == PointerEventButton.right {
                                            if root.selected_items.length == 0 || !root.item_is_selected(index) {
                                                root.selected_item = index;
                                                root.selected_items = [];
                                            }
                                            item_menu.show();
                                        }
                                    }
                                }
                                
                                item_menu := PopupWindow {
                                    x: item_area.mouse-x;
                                    y: item_area.mouse-y;
                                    width: 120px;
                                    
                                    Rectangle {
                                        background: white;
                                        border-width: 1px;
                                        border-color: #ccc;
                                        border-radius: 4px;
                                        drop-shadow-blur: 10px;
                                        drop-shadow-color: #00000040;
                                        
                                        VerticalBox {
                                            spacing: 0px;
                                            
                                            Rectangle {
                                                height: 32px;
                                                background: del_item_area.has-hover ? Theme.bg_soft : transparent;
                                                
                                                HorizontalBox {
                                                    padding-left: 12px;
                                                    padding-right: 12px;
                                                    
                                                    Text {
                                                        text: Translations.menu_delete;
                                                        font-size: 13px;
                                                        color: Theme.brand_primary;
                                                        vertical-alignment: center;
                                                    }
                                                }
                                                
                                                del_item_area := TouchArea {
                                                    clicked => {
                                                        item_menu.close();
                                                        if root.selected_items.length > 0 {
                                                            root.delete_selected_items();
                                                        } else {
                                                            root.delete_schema_item();
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // Classification Management (two-pane similar to Schema)
            if root.current_page == "classification" : HorizontalBox {
                spacing: 0px;
                // Left pane: top-level classifications
                VerticalBox {
                    horizontal-stretch: 0.4;
                    padding: Layout.standard_padding;
                    spacing: Layout.standard_spacing;
                    HorizontalBox { height: 40px; padding: 5px; spacing: Layout.standard_spacing; alignment: start;
                        Text { text: Translations.label_top_classifications; font-size: 14px; vertical-alignment: center; }
                        Rectangle { width: 32px; height: 32px; border-radius: 4px; background: add_classification_touch.has-hover ? Theme.brand_soft : transparent;
                            Text { x: 0; y: 2px; width: 32px; height: 32px; text: "âž•"; font-size: 18px; horizontal-alignment: center; vertical-alignment: center; }
                            add_classification_touch := TouchArea { clicked => { root.add_classification(); } }
                        }
                        Rectangle { width: 32px; height: 32px; border-radius: 4px; background: export_classifications_touch.has-hover ? Theme.brand_soft : transparent;
                            Text { x: 0; y: 2px; width: 32px; height: 32px; text: "ðŸ“¤"; font-size: 18px; horizontal-alignment: center; vertical-alignment: center; }
                            export_classifications_touch := TouchArea { clicked => { root.export_classifications(); } }
                        }
                        Rectangle { width: 32px; height: 32px; border-radius: 4px; background: import_classifications_touch.has-hover ? Theme.brand_soft : transparent;
                            Text { x: 0; y: 2px; width: 32px; height: 32px; text: "ðŸ“¥"; font-size: 18px; horizontal-alignment: center; vertical-alignment: center; }
                            import_classifications_touch := TouchArea { clicked => { root.import_classifications(); } }
                        }
                    }
                    ScrollView {
                        VerticalBox {
                            for classification_item[index] in root.classification_items : Rectangle {
                                height: 50px;
                                background: root.selected_classifications.length > 0 ? (root.classification_is_selected(index) ? (classification_item.is_active ? Theme.list_selected : Theme.list_selected_inactive) : Theme.list_background) : (root.selected_classification == index ? (classification_item.is_active ? Theme.list_selected : Theme.list_selected_inactive) : Theme.list_background);
                                border-width: 1px; border-color: Theme.nav_border;
                                VerticalBox { padding-left: 10px; padding-right: 10px; padding-top: 6px; padding-bottom: 6px; spacing: 2px;
                                    Text { text: classification_item.code; font-size: 14px; font-weight: 600; color: classification_item.is_active ? #333 : #999; overflow: elide; }
                                    Text { text: classification_item.name; font-size: 12px; color: classification_item.is_active ? #666 : #bbb; overflow: elide; }
                                }
                                classification_area := TouchArea {
                                    pointer-event(event) => {
                                        if event.kind == PointerEventKind.down && event.button == PointerEventButton.left {
                                            root.classification_item_clicked(index, event.modifiers.control, event.modifiers.shift);
                                        }
                                        if event.kind == PointerEventKind.up && event.button == PointerEventButton.right {
                                            if root.selected_classifications.length == 0 || !root.classification_is_selected(index) {
                                                root.selected_classification = index;
                                                root.selected_classifications = [];
                                            }
                                            classification_menu.show();
                                        }
                                    }
                                }
                                classification_menu := PopupWindow { x: classification_area.mouse-x; y: classification_area.mouse-y; width: 120px;
                                    Rectangle { background: white; border-width: 1px; border-color: #ccc; border-radius: 4px; drop-shadow-blur: 10px; drop-shadow-color: #00000040;
                                        VerticalBox { spacing: 0px;
                                            Rectangle { height: 32px; background: del_classification_area.has-hover ? Theme.bg_soft : transparent;
                                                HorizontalBox { padding-left: 12px; padding-right: 12px; Text { text: Translations.menu_delete; font-size: 13px; color: Theme.brand_primary; vertical-alignment: center; } }
                                                del_classification_area := TouchArea { clicked => { classification_menu.close(); if root.selected_classifications.length > 0 { root.delete_selected_classifications(); } else { root.delete_classification(); } } }
                                            }
                                            Rectangle { height: 1px; background: Theme.nav_border; }
                                            Rectangle { height: 32px; background: activate_classification_area.has-hover ? Theme.bg_soft : transparent;
                                                HorizontalBox { padding-left: 12px; padding-right: 12px; Text { text: Translations.menu_activate; font-size: 13px; vertical-alignment: center; } }
                                                activate_classification_area := TouchArea { clicked => { classification_menu.close(); root.activate_classification(); } }
                                            }
                                            Rectangle { height: 32px; background: deactivate_classification_area.has-hover ? Theme.bg_soft : transparent;
                                                HorizontalBox { padding-left: 12px; padding-right: 12px; Text { text: Translations.menu_deactivate; font-size: 13px; vertical-alignment: center; } }
                                                deactivate_classification_area := TouchArea { clicked => { classification_menu.close(); root.deactivate_classification(); } }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                Rectangle { width: Layout.separator_width; background: Theme.nav_border; }
                // Right pane: child classifications
                VerticalBox {
                    horizontal-stretch: 0.6;
                    padding: Layout.standard_padding;
                    spacing: Layout.standard_spacing;
                    HorizontalBox { height: 40px; padding: 5px; spacing: Layout.standard_spacing; alignment: start;
                        Text { text: Translations.label_child_classifications; font-size: 14px; vertical-alignment: center; }
                        Rectangle { width: 32px; height: 32px; border-radius: 4px; background: add_child_classification_touch.has-hover ? Theme.brand_soft : transparent;
                            Text { x: 0; y: 2px; width: 32px; height: 32px; text: "âž•"; font-size: 18px; horizontal-alignment: center; vertical-alignment: center; }
                            add_child_classification_touch := TouchArea { clicked => { root.add_child_classification(); } }
                        }
                    }
                    ScrollView {
                        VerticalBox {
                            for child_item[index] in root.classification_children : Rectangle {
                                height: 50px;
                                background: root.selected_children.length > 0 ? (root.child_is_selected(index) ? (child_item.is_active ? Theme.list_selected : Theme.list_selected_inactive) : Theme.list_background) : (root.selected_child == index ? (child_item.is_active ? Theme.list_selected : Theme.list_selected_inactive) : Theme.list_background);
                                border-width: 1px; border-color: Theme.nav_border;
                                VerticalBox { padding-left: 10px; padding-right: 10px; padding-top: 6px; padding-bottom: 6px; spacing: 2px;
                                    Text { text: child_item.code; font-size: 14px; font-weight: 600; color: child_item.is_active ? #333 : #999; overflow: elide; }
                                    Text { text: child_item.name; font-size: 12px; color: child_item.is_active ? #666 : #bbb; overflow: elide; }
                                }
                                child_area := TouchArea {
                                    pointer-event(event) => {
                                        if event.kind == PointerEventKind.down && event.button == PointerEventButton.left {
                                            root.child_classification_clicked(index, event.modifiers.control, event.modifiers.shift);
                                        }
                                        if event.kind == PointerEventKind.up && event.button == PointerEventButton.right {
                                            if root.selected_children.length == 0 || !root.child_is_selected(index) {
                                                root.selected_child = index;
                                                root.selected_children = [];
                                            }
                                            child_menu.show();
                                        }
                                    }
                                }
                                child_menu := PopupWindow { x: child_area.mouse-x; y: child_area.mouse-y; width: 120px;
                                    Rectangle { background: white; border-width: 1px; border-color: #ccc; border-radius: 4px; drop-shadow-blur: 10px; drop-shadow-color: #00000040;
                                        VerticalBox { spacing: 0px;
                                            Rectangle { height: 32px; background: del_child_area.has-hover ? Theme.bg_soft : transparent;
                                                HorizontalBox { padding-left: 12px; padding-right: 12px; Text { text: Translations.menu_delete; font-size: 13px; color: Theme.brand_primary; vertical-alignment: center; } }
                                                del_child_area := TouchArea { clicked => { child_menu.close(); if root.selected_children.length > 0 { root.delete_selected_children(); } else { root.delete_child_classification(); } } }
                                            }
                                            Rectangle { height: 1px; background: Theme.nav_border; }
                                            Rectangle { height: 32px; background: activate_child_area.has-hover ? Theme.bg_soft : transparent;
                                                HorizontalBox { padding-left: 12px; padding-right: 12px; Text { text: Translations.menu_activate; font-size: 13px; vertical-alignment: center; } }
                                                activate_child_area := TouchArea { clicked => { child_menu.close(); root.activate_child_classification(); } }
                                            }
                                            Rectangle { height: 32px; background: deactivate_child_area.has-hover ? Theme.bg_soft : transparent;
                                                HorizontalBox { padding-left: 12px; padding-right: 12px; Text { text: Translations.menu_deactivate; font-size: 13px; vertical-alignment: center; } }
                                                deactivate_child_area := TouchArea { clicked => { child_menu.close(); root.deactivate_child_classification(); } }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // Settings
            if root.current_page == "settings" : VerticalBox {
                height: 500px;  // Increased height for archive library management
                padding: Layout.standard_padding;
                spacing: Layout.standard_spacing;

                GroupBox {
                    title: Translations.label_language;
                    HorizontalBox {
                        padding: Layout.standard_padding;
                        Text { text: Translations.label_language; width: 100px; }
                        ComboBox {
                            model: ["ä¸­æ–‡ (Chinese)", "English (è‹±æ–‡)"];
                            current-index <=> Translations.language;
                        }
                    }
                }

                GroupBox {
                    title: Translations.label_archive_libraries;
                    VerticalBox {
                        padding: Layout.standard_padding;
                        spacing: Layout.standard_spacing;

                        // Toolbar for archive library management - icon button only
                        HorizontalBox {
                            height: 40px;
                            padding: 5px;
                            spacing: Layout.standard_spacing;
                            alignment: start;
                            
                            // Icon button for adding archive library
                            Rectangle {
                                width: 32px;
                                height: 32px;
                                border-radius: 4px;
                                background: add_touch.has-hover ? Theme.brand_soft : transparent;
                                
                                Text {
                                    x: 0;
                                    y: 2px;
                                    width: 32px;
                                    height: 32px;
                                    text: "âž•";
                                    font-size: 18px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                                
                                add_touch := TouchArea {
                                    clicked => { root.add_archive_library(); }
                                }
                            }
                        }

                        // Archive library list with scroll - display name and path
                        ScrollView {
                            height: 250px;
                            VerticalBox {
                                for item[index] in root.archive_library_items : Rectangle {
                                    height: 60px;
                                    background: root.selected_archive == index ? Theme.list_selected : Theme.list_background;
                                    border-width: 1px;
                                    border-color: Theme.nav_border;
                                    
                                    VerticalBox {
                                        padding-left: 10px;
                                        padding-right: 10px;
                                        padding-top: 8px;
                                        padding-bottom: 8px;
                                        spacing: 4px;
                                        
                                        // Library name
                                        Text {
                                            text: item.name;
                                            font-size: 14px;
                                            font-weight: 600;
                                            color: #333;
                                            overflow: elide;
                                        }
                                        
                                        // Library path
                                        Text {
                                            text: item.path;
                                            font-size: 12px;
                                            color: #666;
                                            overflow: elide;
                                        }
                                    }
                                    
                                    item_touch := TouchArea {
                                        clicked => { root.selected_archive = index; }
                                        
                                        // Right-click menu
                                        pointer-event(event) => {
                                            if event.kind == PointerEventKind.up && event.button == PointerEventButton.right {
                                                root.selected_archive = index;
                                                context_menu.show();
                                            }
                                        }
                                    }
                                    
                                    // Context menu popup
                                    context_menu := PopupWindow {
                                        x: item_touch.mouse-x;
                                        y: item_touch.mouse-y;
                                        width: 120px;
                                        
                                        Rectangle {
                                            background: white;
                                            border-width: 1px;
                                            border-color: #ccc;
                                            border-radius: 4px;
                                            drop-shadow-blur: 10px;
                                            drop-shadow-color: #00000040;
                                            
                                            VerticalBox {
                                                spacing: 0px;
                                                
                                                // Rename option
                                                Rectangle {
                                                    height: 32px;
                                                    background: rename_touch.has-hover ? Theme.bg_soft : transparent;
                                                    
                                                    HorizontalBox {
                                                        padding-left: 12px;
                                                        padding-right: 12px;
                                                        
                                                        Text {
                                                            text: Translations.menu_rename;
                                                            font-size: 13px;
                                                            vertical-alignment: center;
                                                        }
                                                    }
                                                    
                                                    rename_touch := TouchArea {
                                                        clicked => {
                                                            context_menu.close();
                                                            // Trigger rename dialog (to be handled in Rust)
                                                            root.rename_archive_library(index, item.name);
                                                        }
                                                    }
                                                }
                                                
                                                // Separator
                                                Rectangle {
                                                    height: 1px;
                                                    background: Theme.nav_border;
                                                }
                                                
                                                // Delete option
                                                Rectangle {
                                                    height: 32px;
                                                    background: delete_touch.has-hover ? Theme.bg_soft : transparent;
                                                    
                                                    HorizontalBox {
                                                        padding-left: 12px;
                                                        padding-right: 12px;
                                                        
                                                        Text {
                                                            text: Translations.menu_delete;
                                                            font-size: 13px;
                                                            color: Theme.brand_primary;
                                                            vertical-alignment: center;
                                                        }
                                                    }
                                                    
                                                    delete_touch := TouchArea {
                                                        clicked => {
                                                            context_menu.close();
                                                            root.selected_archive = index;
                                                            root.remove_archive_library();
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                HorizontalBox {
                    alignment: end;
                    spacing: Layout.standard_spacing;
                    ThemedButton { text: Translations.btn_cancel; is_primary: false; clicked => { root.cancel_settings(); } }
                    ThemedButton { text: Translations.btn_apply; is_primary: true; clicked => { root.apply_settings(); } }
                }
            }
            
            // Files Management
            if root.current_page == "files" : HorizontalBox {
                spacing: 0px;
                
                // Left side
                VerticalBox {
                    width: 200px;
                    padding: Layout.standard_padding;
                    spacing: Layout.standard_spacing;
                    
                    Rectangle {
                        height: Layout.toolbar_height;
                        background: Theme.toolbar_background;
                        
                        HorizontalBox {
                            padding: Layout.standard_padding;
                            spacing: Layout.standard_spacing;
                            
                            Text { text: Translations.label_series; font-size: 14px; }
                            ThemedButton { text: Translations.btn_refresh; is_primary: true; clicked => { root.update_series(); } }
                        }
                    }
                    
                    VerticalBox {
                        for item[index] in root.series : Rectangle {
                            height: Layout.list_item_height;
                            background: root.selected_series == index ? Theme.list_selected : Theme.list_background;
                            HorizontalBox {
                                padding: Layout.standard_spacing;
                                Text { text: item; }
                            }
                            TouchArea {
                                clicked => { root.selected_series = index; }
                            }
                        }
                    }
                }
                
                // Divider
                Rectangle {
                    width: Layout.separator_width;
                    background: Theme.nav_border;
                }
                
                // Right side
                VerticalBox {
                    padding: Layout.standard_padding;
                    spacing: Layout.standard_spacing;
                    
                    Rectangle {
                        height: Layout.toolbar_height;
                        background: Theme.toolbar_background;
                        
                        HorizontalBox {
                            padding: Layout.standard_padding;
                            spacing: Layout.standard_spacing;
                            
                            Text { text: Translations.label_files; font-size: 14px; }
                            ThemedButton { text: Translations.btn_add; is_primary: true; clicked => { root.add_file(); } }
                            ThemedButton { text: Translations.btn_delete; is_primary: false; clicked => { root.delete_file(); } }
                            ThemedButton { text: Translations.btn_open; is_primary: true; clicked => { root.open_file(); } }
                        }
                    }
                    
                    VerticalBox {
                        for item[index] in root.files : Rectangle {
                            height: Layout.list_item_height;
                            background: root.selected_file == index ? Theme.list_selected : Theme.list_background;
                            HorizontalBox {
                                padding: Layout.standard_spacing;
                                Text { text: item; }
                            }
                            
                            TouchArea {
                                double-clicked => { root.open_file(); }
                            }
                        }
                    }
                }
            }
        }
    }
    
    // Tooltip layer - rendered at window level, always on top
    if btn_fonds.is_hovered : Rectangle {
        x: 55px;
        y: 9px;
        width: 100px;
        height: 32px;
        background: #333;
        border-radius: 4px;
        border-width: 1px;
        border-color: #555;
        
        Text {
            x: 0px;
            y: 0px;
            width: 100%;
            height: 100%;
            text: btn_fonds.tooltip;
            font-size: 12px;
            color: white;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
    
    if btn_schema.is_hovered : Rectangle {
        x: 55px;
        y: 59px;
        width: 100px;
        height: 32px;
        background: #333;
        border-radius: 4px;
        border-width: 1px;
        border-color: #555;
        
        Text {
            x: 0px;
            y: 0px;
            width: 100%;
            height: 100%;
            text: btn_schema.tooltip;
            font-size: 12px;
            color: white;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
    
    if btn_classification.is_hovered : Rectangle {
        x: 55px;
        y: 109px;
        width: 120px;
        height: 32px;
        background: #333;
        border-radius: 4px;
        border-width: 1px;
        border-color: #555;
        Text { x: 0px; y: 0px; width: 100%; height: 100%; text: btn_classification.tooltip; font-size: 12px; color: white; horizontal-alignment: center; vertical-alignment: center; }
    }

    if btn_settings.is_hovered : Rectangle {
        x: 55px;
        y: 159px;
        width: 100px;
        height: 32px;
        background: #333;
        border-radius: 4px;
        border-width: 1px;
        border-color: #555;
        
        Text {
            x: 0px;
            y: 0px;
            width: 100%;
            height: 100%;
            text: btn_settings.tooltip;
            font-size: 12px;
            color: white;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
    
    if btn_files.is_hovered : Rectangle {
        x: 55px;
        y: 209px;
        width: 100px;
        height: 32px;
        background: #333;
        border-radius: 4px;
        border-width: 1px;
        border-color: #555;
        
        Text {
            x: 0px;
            y: 0px;
            width: 100%;
            height: 100%;
            text: btn_files.tooltip;
            font-size: 12px;
            color: white;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
    
    // Toast notification
    if root.toast_visible : Rectangle {
        x: parent.width / 2 - self.width / 2;
        y: parent.height - 100px;
        width: Math.min(400px, parent.width - 40px);
        height: toast_text.preferred-height + 24px;
        background: #333;
        border-radius: 6px;
        opacity: 0.95;
        
        toast_text := Text {
            x: 12px;
            y: 12px;
            width: parent.width - 24px;
            text: root.toast_message;
            font-size: 14px;
            font-family: "Microsoft YaHei";
            color: white;
            wrap: word-wrap;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
        
        // Auto-hide animation
        animate opacity {
            duration: 300ms;
        }
    }
}
