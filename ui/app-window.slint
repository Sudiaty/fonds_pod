import { HorizontalBox } from "std-widgets.slint";
import { Theme, Layout } from "theme.slint";
import { NavigationPanel } from "layout/navigation.slint";
import { TooltipLayer } from "components/tooltip.slint";
import { AboutPage } from "pages/about-page.slint";
import { SettingsPage } from "pages/settings-page.slint";
import { HomePage } from "pages/home-page.slint";
import { FondClassificationPage } from "pages/fond-classification-page.slint";
import { FondPage } from "pages/fond-page.slint";
import { SchemaPage } from "pages/schema-page.slint";
import { CrudListItem, CrudListRowStyle, DialogField, DialogFieldType, SeriesItem, FileItem, ItemItem, SchemaOption, ClassificationOption, FondsSchemaOption } from "models.slint";
import { AddFondsDialog } from "dialogs.slint";

export component AppWindow inherits Window {
    title: "FondsPod";
    icon: @image-url("images/logo.png");
    width: 1000px;
    height: 700px;
    background: Theme.bg_primary;
    default-font-family: "Microsoft YaHei";
    default-font-size: 14px;
    
    // Force generation of types for independent dialogs (not used, just ensures Rust codegen)
    private property <[FondsSchemaOption]> _unused_schema_options: [];
    
    // Translation properties for common UI messages using gettext
    out property <string> language_applied: @tr("" => "language_applied");
    out property <string> code_exists: @tr("" => "code_exists");
    out property <string> create_failed: @tr("" => "create_failed");
    out property <string> tray_show_window: @tr("" => "tray_show_window");
    out property <string> tray_quit: @tr("" => "tray_quit");
    out property <string> delete_failed: @tr("" => "delete_failed");
    out property <string> cannot_delete: @tr("" => "cannot_delete");
    out property <string> activate_failed: @tr("" => "activate_failed");
    out property <string> deactivate_failed: @tr("" => "deactivate_failed");
    out property <string> export_failed: @tr("" => "export_failed");
    out property <string> import_failed: @tr("" => "import_failed");
    out property <string> no_archive_selected: @tr("" => "no_archive_selected");
    out property <string> import_success: @tr("" => "import_success");
    out property <string> export_success: @tr("" => "export_success");
    out property <string> read_file_failed: @tr("" => "read_file_failed");
    
    // Application version
    in property <string> app_version: "1.0.0";
    
    // Current page state
    property <string> current_page: "home";
    
    // Settings page properties
    in-out property <int> selected_language: 0;
    in-out property <[CrudListItem]> archive_libraries: [];
    in-out property <int> selected_archive: -1;
    in-out property <bool> show_add_archive_dialog: false;
    in-out property <bool> show_rename_archive_dialog: false;
    in-out property <[DialogField]> add_archive_fields: [];
    in-out property <[DialogField]> rename_archive_fields: [];
    in-out property <string> last_opened_library: "";
    in-out property <[string]> library_names: [];

    // Home page properties
    in-out property <[string]> fonds_names: [];
    in-out property <int> selected_fonds: 0;
    in-out property <[CrudListItem]> series_list_items: [];
    in-out property <int> selected_series_index: -1;
    in-out property <string> selected_series_no: "";
    in-out property <[CrudListItem]> files_list_items: [];
    in-out property <int> selected_file: 0;
    in-out property <[CrudListItem]> items_list_items: [];
    in-out property <int> selected_item: 0;
    in-out property <string> open_file_path: "";
    in-out property <string> open_item_path: "";
    
    // Add file dialog state
    in-out property <bool> show_add_file_dialog: false;
    in-out property <[DialogField]> add_file_fields: [];
    
    // Add item dialog state
    in-out property <bool> show_add_item_dialog: false;
    in-out property <[DialogField]> add_item_fields: [];
    
    // Add fonds dialog state
    in-out property <bool> show_add_fonds_dialog: false;
    
    // Add fonds dialog properties
    in-out property <string> add_fonds_name: "";
    in-out property <[string]> primary_classifications: [];
    in-out property <[[string]]> secondary_classifications: [];
    in-out property <int> selected_primary_classification: 0;
    in-out property <int> selected_secondary_classification: 0;
    in-out property <[FondsSchemaOption]> available_schemas: [];
    in-out property <[FondsSchemaOption]> selected_schemas: [];
    in-out property <int> highlighted_available_schema: -1;
    in-out property <int> highlighted_chosen_schema: -1;
    
    // Fond page properties
    in property <[CrudListItem]> fond_items: [];
    callback fond_add();
    callback fond_delete(int);
    
    // Schema page properties
    in property <[CrudListItem]> schema_list_items: [];
    in property <[CrudListItem]> detail_list_items: [];
    callback schema_add();
    callback schema_delete();
    callback schema_item_clicked(int);
    callback schema_activated(int);
    callback schema_item_add();
    callback schema_item_delete();
    callback schema_item_item_clicked(int);
    callback schema_item_activated(int);
    
    // Schema dialog properties
    in-out property <bool> show_add_schema_dialog: false;
    in-out property <bool> show_add_schema_item_dialog: false;
    in-out property <[DialogField]> add_schema_fields: [
        { label: "label_code", field_type: DialogFieldType.text, value: "", placeholder: @tr("" => "placeholder_code") },
        { label: "label_name", field_type: DialogFieldType.text, value: "", placeholder: @tr("" => "placeholder_name") },
    ];
    in-out property <[DialogField]> add_schema_item_fields: [
        { label: "label_code", field_type: DialogFieldType.text, value: "", placeholder: @tr("" => "placeholder_code") },
        { label: "label_name", field_type: DialogFieldType.text, value: "", placeholder: @tr("" => "placeholder_name") },
    ];
    
    // Schema dialog callbacks
    callback confirm_add_schema([DialogField]);
    callback cancel_add_schema();
    callback confirm_add_schema_item([DialogField]);
    callback cancel_add_schema_item();
    
    // Fond Classification page properties
    in property <[CrudListItem]> classification_crud_items: [];
    in-out property <int> selected_classification: 0;

    in property <[CrudListItem]> child_crud_items: [];
    in-out property <int> selected_child: 0;

    in property <[CrudListRowStyle]> classification_row_styles: [];
    in property <[CrudListRowStyle]> child_row_styles: [];
    
    // Dialog states for fond classifications
    in-out property <bool> show_add_top_classification_dialog: false;
    in-out property <bool> show_add_child_classification_dialog: false;
    in-out property <[DialogField]> add_top_classification_fields: [
        { label: "label_code", field_type: DialogFieldType.text, value: "", placeholder: @tr("" => "placeholder_code") },
        { label: "label_name", field_type: DialogFieldType.text, value: "", placeholder: @tr("" => "placeholder_name") },
    ];
    in-out property <[DialogField]> add_child_classification_fields: [
        { label: "label_code", field_type: DialogFieldType.text, value: "", placeholder: @tr("" => "placeholder_child_code") },
        { label: "label_name", field_type: DialogFieldType.text, value: "", placeholder: @tr("" => "placeholder_child_name") },
    ];
    
    // Toast notification properties
    in-out property <string> toast_message: "";
    in-out property <bool> toast_visible: false;
    
    // Main navigation callback
    callback page_changed(string);
    callback set_selected_path(string);
    callback show_toast(string);
    callback check_update();
    callback add_archive_library();
    callback remove_archive_library();
    callback rename_archive_library(int, string);
    callback archive_selected(int);
    callback apply_settings();
    callback cancel_settings();
    callback browse_folder();
    callback load_fond_classifications();
    callback select_fond_classification(int);
    callback delete_fond_classification(int);
    callback add_classification();
    callback classification_item_clicked(int);
    callback classification_item_activated(int);  // Callback for item activation
    callback activate_top_classification(int);    // Activate by id
    callback deactivate_top_classification(int);  // Deactivate by id
    callback export_classifications();
    callback import_classifications();
    callback add_child_classification();
    callback delete_child_classification(int);
    callback child_classification_clicked(int);
    callback child_classification_activated(int);  // Callback for child item activation
    callback activate_child_classification(int);   // Activate by id
    callback deactivate_child_classification(int); // Deactivate by id
    
    // Dialog callbacks for fond classifications
    callback confirm_add_top_classification([DialogField]);
    callback cancel_add_top_classification();
    callback confirm_add_child_classification([DialogField]);
    callback cancel_add_child_classification();
    
    // Home page callbacks
    callback initialize_home_page();
    callback request_add_fonds_dialog();
    callback confirm_add_fonds(string, string, [FondsSchemaOption]); // name, classification_code, selected_schemas
    callback cancel_add_fonds();
    callback toggle_schema_selection(int);
    callback move_schema_to_selected(int);
    callback move_schema_back(int);
    callback fonds_selected(int);  // index
    callback series_selected(int); // index
    callback open_fonds(string);
    callback select_series(int, string);
    callback series_activated(int);
    callback rebuild_series();
    callback delete_series();
    callback add_file();  // Will generate default name
    callback delete_file();
    callback rename_file(int, string);
    callback file_clicked(int);
    callback file_activated(int);
    callback open_file();
    callback open_file_at(int);
    callback add_item();  // Will generate default name
    callback delete_item();
    callback rename_item(int, string);
    callback item_clicked(int);
    callback item_activated(int);
    callback open_item();
    callback open_item_at(int);
    callback file_selected(int);
    
    // Add file dialog callbacks
    callback confirm_add_file([DialogField]);
    callback cancel_add_file();
    callback browse_file_folder(int);
    
    // Add item dialog callbacks
    callback confirm_add_item([DialogField]);
    callback cancel_add_item();
    callback browse_item_folder(int);
    
    show_toast(message) => {
        root.toast_message = message;
        root.toast_visible = true;
        // Toast will be managed by external logic
    }
    
    HorizontalBox {
        spacing: 0px;
        padding-left: 10px;

        nav_panel := NavigationPanel {
            width: Layout.nav_width;
            height: parent.height;
            current_page <=> root.current_page;
            navigate(page_id) => { 
                root.current_page = page_id; 
                root.page_changed(page_id);
            }
        }

        Rectangle {
            width: Layout.separator_width;
            height: parent.height;
            background: Theme.nav_border;
        }

        Rectangle {
            horizontal-stretch: 1;
            height: 100%;
            background: Theme.bg_primary;

            // Main content area
            Rectangle {
                width: parent.width;
                height: parent.height;
                background: transparent;
                
                if root.current_page == "home" : HomePage {
                    width: parent.width;
                    height: parent.height;
                    library_names <=> root.library_names;
                    selected_archive <=> root.selected_archive;
                    last_opened_library <=> root.last_opened_library;
                    fonds_names <=> root.fonds_names;
                    selected_fonds <=> root.selected_fonds;
                    series_list_items <=> root.series_list_items;
                    selected_series_index <=> root.selected_series_index;
                    selected_series_no <=> root.selected_series_no;
                    files_list_items <=> root.files_list_items;
                    selected_file <=> root.selected_file;
                    items_list_items <=> root.items_list_items;
                    selected_item <=> root.selected_item;
                    open_file_path <=> root.open_file_path;
                    open_item_path <=> root.open_item_path;
                    show_add_file_dialog <=> root.show_add_file_dialog;
                    add_file_fields <=> root.add_file_fields;
                    show_add_item_dialog <=> root.show_add_item_dialog;
                    add_item_fields <=> root.add_item_fields;
                    current_language: root.selected_language;
                    initialize => { root.initialize_home_page(); }
                    archive_selected(index) => { root.archive_selected(index); }
                    request_add_fonds_dialog() => { root.request_add_fonds_dialog(); }
                    open_fonds(fonds) => { root.open_fonds(fonds); }
                    select_series(index, series_no) => { root.select_series(index, series_no); }
                    series_activated(index) => { root.series_activated(index); }
                    rebuild_series() => { root.rebuild_series(); }
                    delete_series() => { root.delete_series(); }
                    add_file() => { root.add_file(); }
                    confirm_add_file(fields) => { root.confirm_add_file(fields); }
                    cancel_add_file() => { root.cancel_add_file(); }
                    browse_file_folder(index) => { root.browse_file_folder(index); }
                    confirm_add_item(fields) => { root.confirm_add_item(fields); }
                    cancel_add_item() => { root.cancel_add_item(); }
                    browse_item_folder(index) => { root.browse_item_folder(index); }
                    delete_file() => { root.delete_file(); }
                    rename_file(index, name) => { root.rename_file(index, name); }
                    file_clicked(index) => { root.file_clicked(index); }
                    file_activated(index) => { root.file_activated(index); }
                    open_file() => { root.open_file(); }
                    open_file_at(index) => { root.open_file_at(index); }
                    add_item() => { root.add_item(); }
                    delete_item() => { root.delete_item(); }
                    rename_item(index, name) => { root.rename_item(index, name); }
                    item_clicked(index) => { root.item_clicked(index); }
                    item_activated(index) => { root.item_activated(index); }
                    open_item() => { root.open_item(); }
                    open_item_at(index) => { root.open_item_at(index); }
                    file_selected(index) => { root.file_selected(index); }
                }
                
                if root.current_page == "about" : AboutPage {
                    width: parent.width;
                    height: parent.height;
                    app_version: root.app_version;
                    check_update => { root.check_update(); }
                }
                
                if root.current_page == "settings" : SettingsPage {
                    width: parent.width;
                    height: parent.height;
                    selected_language <=> root.selected_language;
                    archive_libraries <=> root.archive_libraries;
                    selected_archive <=> root.selected_archive;
                    show_add_archive_dialog <=> root.show_add_archive_dialog;
                    show_rename_archive_dialog <=> root.show_rename_archive_dialog;
                    add_archive_fields <=> root.add_archive_fields;
                    rename_archive_fields <=> root.rename_archive_fields;
                    add_archive_library => { root.add_archive_library(); }
                    remove_archive_library => { root.remove_archive_library(); }
                    rename_archive_library(index, name) => { root.rename_archive_library(index, name); }
                    archive_selected(index) => { root.archive_selected(index); }
                    apply_settings => { root.apply_settings(); }
                    cancel_settings => { root.cancel_settings(); }
                    browse_folder => { root.browse_folder(); }
                }
                
                if root.current_page == "classification" : FondClassificationPage {
                    width: parent.width;
                    height: parent.height;
                    classification_crud_items <=> root.classification_crud_items;
                    selected_classification <=> root.selected_classification;
                    child_crud_items <=> root.child_crud_items;
                    selected_child <=> root.selected_child;
                    classification_row_styles <=> root.classification_row_styles;
                    child_row_styles <=> root.child_row_styles;
                    show_add_top_classification_dialog <=> root.show_add_top_classification_dialog;
                    show_add_child_classification_dialog <=> root.show_add_child_classification_dialog;
                    add_top_classification_fields <=> root.add_top_classification_fields;
                    add_child_classification_fields <=> root.add_child_classification_fields;
                    confirm_add_top_classification(fields) => { root.confirm_add_top_classification(fields); }
                    cancel_add_top_classification => { root.cancel_add_top_classification(); }
                    confirm_add_child_classification(fields) => { root.confirm_add_child_classification(fields); }
                    cancel_add_child_classification => { root.cancel_add_child_classification(); }
                    add_classification => { root.add_classification(); }
                    delete_classification(index) => { root.delete_fond_classification(index); }
                    classification_item_clicked(index) => { root.classification_item_clicked(index); }
                    classification_item_activated(index) => { root.classification_item_activated(index); }
                    activate_top_classification(id) => { root.activate_top_classification(id); }
                    deactivate_top_classification(id) => { root.deactivate_top_classification(id); }
                    export_classifications => { root.export_classifications(); }
                    import_classifications => { root.import_classifications(); }
                    add_child_classification => { root.add_child_classification(); }
                    delete_child_classification(index) => { root.delete_child_classification(index); }
                    child_classification_clicked(index) => { root.child_classification_clicked(index); }
                    child_classification_activated(index) => { root.child_classification_activated(index); }
                    activate_child_classification(id) => { root.activate_child_classification(id); }
                    deactivate_child_classification(id) => { root.deactivate_child_classification(id); }
                }
                
                if root.current_page == "fonds" : FondPage {
                    width: parent.width;
                    height: parent.height;
                    items: root.fond_items;
                    add-clicked => { root.fond_add(); }
                    delete-clicked(idx) => { root.fond_delete(idx); }
                }
                
                if root.current_page == "schema" : SchemaPage {
                    width: parent.width;
                    height: parent.height;
                    schema_list_items: root.schema_list_items;
                    detail_list_items: root.detail_list_items;
                    add_schema => { root.schema_add(); }
                    delete_schema => { root.schema_delete(); }
                    schema_item_clicked(index) => { root.schema_item_clicked(index); }
                    schema_activated(index) => { root.schema_activated(index); }
                    add_schema_item => { root.schema_item_add(); }
                    delete_schema_item => { root.schema_item_delete(); }
                    schema_item_item_clicked(index) => { root.schema_item_item_clicked(index); }
                    schema_item_activated(index) => { root.schema_item_activated(index); }
                    show_add_schema_dialog <=> root.show_add_schema_dialog;
                    show_add_schema_item_dialog <=> root.show_add_schema_item_dialog;
                    add_schema_fields <=> root.add_schema_fields;
                    add_schema_item_fields <=> root.add_schema_item_fields;
                    confirm_add_schema(fields) => { root.confirm_add_schema(fields); }
                    cancel_add_schema => { root.cancel_add_schema(); }
                    confirm_add_schema_item(fields) => { root.confirm_add_schema_item(fields); }
                    cancel_add_schema_item => { root.cancel_add_schema_item(); }
                }
                
                if root.current_page != "about" && root.current_page != "settings" && root.current_page != "home" && root.current_page != "classification" && root.current_page != "fonds" && root.current_page != "schema" : Text {
                    x: parent.width / 2 - self.width / 2;
                    y: parent.height / 2 - self.height / 2;
                    text: "Current Page: " + root.current_page;
                    font-size: 18px;
                    color: Theme.text_secondary;
                }
            }
        }
    }
    
    // Navigation tooltips (positioned to the right of nav buttons)
    TooltipLayer { 
        is_hovered: nav_panel.home_hovered; 
        offset_y: 9px; 
        offset_x: 65px; 
        text: @tr("nav_home"); 
    }
    TooltipLayer { 
        is_hovered: nav_panel.fonds_hovered; 
        offset_y: 59px; 
        offset_x: 65px; 
        text: @tr("nav_fonds"); 
    }
    TooltipLayer { 
        is_hovered: nav_panel.schema_hovered; 
        offset_y: 109px; 
        offset_x: 65px; 
        text: @tr("nav_schema"); 
    }
    TooltipLayer { 
        is_hovered: nav_panel.classification_hovered; 
        offset_y: 159px; 
        offset_x: 65px; 
        tooltip_width: 120px; 
        text: @tr("nav_classification"); 
    }
    TooltipLayer { 
        is_hovered: nav_panel.settings_hovered; 
        offset_y: 209px; 
        offset_x: 65px; 
        text: @tr("nav_settings"); 
    }
    TooltipLayer { 
        is_hovered: nav_panel.about_hovered; 
        offset_y: 259px; 
        offset_x: 65px; 
        text: @tr("nav_about"); 
    }
    
    // Toast notification overlay
    if root.toast_visible : Rectangle {
        x: parent.width / 2 - self.width / 2;
        y: parent.height - 100px;
        width: Math.min(400px, parent.width - 40px);
        height: toast_text.preferred-height + 24px;
        background: #333;
        border-radius: 6px;
        opacity: 0.95;
        
        toast_text := Text {
            x: 12px;
            y: 12px;
            width: parent.width - 24px;
            text: root.toast_message;
            font-size: 14px;
            font-family: "Microsoft YaHei";
            color: white;
            wrap: word-wrap;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
        
        // Auto-hide animation
        animate opacity {
            duration: 300ms;
        }
    }
    
    // Add Fonds Dialog Overlay
    if root.show_add_fonds_dialog: add_fonds_dialog := AddFondsDialog {
        visible: root.show_add_fonds_dialog;
        primary_classifications <=> root.primary_classifications;
        secondary_classifications <=> root.secondary_classifications;
        selected_primary_classification <=> root.selected_primary_classification;
        selected_secondary_classification <=> root.selected_secondary_classification;
        available_schema_items <=> root.available_schemas;
        chosen_schema_items <=> root.selected_schemas;
        highlighted_available_schema <=> root.highlighted_available_schema;
        highlighted_chosen_schema <=> root.highlighted_chosen_schema;
        fonds_name_input <=> root.add_fonds_name;
        
        confirm() => {
            root.confirm_add_fonds(add_fonds_dialog.fonds_name_input, "", add_fonds_dialog.chosen_schema_items);
            root.show_add_fonds_dialog = false;
        }
        
        cancel() => {
            root.show_add_fonds_dialog = false;
        }
        
        move_schema_to_selected(index) => {
            root.move_schema_to_selected(index);
        }
        
        move_schema_back(index) => {
            root.move_schema_back(index);
        }
    }
}
